app-id: com.makemkv.MakeMKV
runtime: org.kde.Platform
runtime-version: 5.15-25.08
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk8
finish-args:
  - --filesystem=~/.MakeMKV:create
  - --filesystem=xdg-videos
  # Wayland access
  - --socket=wayland
  # X11 access
  - --socket=fallback-x11
  - --share=ipc
  # Network access
  - --share=network
  # For optical drive access
  - --device=all
  - --env=JAVA_HOME=/app/jre
  - --env=PATH=/app/jre/bin:/app/bin:/usr/bin
command: makemkv
build-options:
  append-path: /usr/lib/sdk/openjdk8/bin
rename-desktop-file: makemkv.desktop
rename-icon: makemkv
cleanup:
  - /include
  - /lib/pkgconfig
modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk8/install.sh
  - name: makemkv-oss
    buildsystem: autotools
    build-options:
      cflags: -D__GNU_SOURCE -D__STDC_CONSTANT_MACROS -D__STDC_LIMIT_MACROS -D __STDC_FORMAT_MACROS
    config-opts:
      - --enable-allcodecs
    make-install-args:
      # really just to avoid call to ldconfig
      - DESTDIR=/
    post-install:
      - install -Dp -m 644 com.makemkv.MakeMKV.appdata.xml --target-directory=/app/share/appdata
      - install -Dp -m 644 License.txt --target-directory=/app/share/licenses/com.makemkv.MakeMKV
    sources:
      - type: archive
        url: https://www.makemkv.com/download/makemkv-oss-1.18.2.tar.gz
        sha256: b9497f5555c257f5d3c7f18b6ab03c74cff3ea4437e80349d618d115bf5fa445
        x-checker-data:
          type: html
          url: https://www.makemkv.com/download
          version-pattern: MakeMKV v([\d\.]*)
          url-template: https://www.makemkv.com/download/makemkv-oss-$version.tar.gz
      - type: file
        path: com.makemkv.MakeMKV.appdata.xml
  - name: makemkv-bin
    buildsystem: simple
    build-commands:
      # TODO: put eula in appstream data once it supports it
      # NOTE: author allows redistribution as long as eula is referenced in package description
      - mkdir -p tmp
      - echo accepted > tmp/eula_accepted
      - make install DESTDIR=/ PREFIX=/app
      - install -Dp -m 644 src/eula_en_linux.txt --target-directory=/app/share/licenses/com.makemkv.MakeMKV
    sources:
      - type: archive
        url: https://www.makemkv.com/download/makemkv-bin-1.18.2.tar.gz
        sha256: bfc4c7cebc0f00497671ffd56e6a34f0770a9e6af7eff2f0127efa143f28636e
        x-checker-data:
          type: html
          url: https://www.makemkv.com/download
          version-pattern: MakeMKV v([\d\.]*)
          url-template: https://www.makemkv.com/download/makemkv-bin-$version.tar.gz
